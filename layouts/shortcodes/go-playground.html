{{ $hlLines := .Get "hl_lines" }}
{{ $lineNos := .Get "lineNos" }}
{{ $split := split .Inner "<!--output-->" }}
{{ $code := index $split 0 }}
{{ $code = trim $code "\n" }}
{{ $output := "" }}
{{ if eq (len $split) 2 }}
    {{ $output = index $split 1 }}
    {{ $output = strings.TrimPrefix "\n" $output }}
{{ end }}

{{ $withoutBoilerplate := false }}
{{ if not (hasPrefix $code "package main") }}
    {{ $code = printf "package main\nimport \"fmt\"\nfunc main() {\n%v\n}" $code }}
    {{ $withoutBoilerplate = true }}
{{ end }}

{{ $code := partial "go-playground/fmt.html" $code }}
{{ $share := partial "go-playground/share.html" $code }}

{{ $compiledOutput := partial "go-playground/compile.html" (dict "this" . "code" $code) }}
{{ if ne $compiledOutput $output }}
  {{ if $output }}
    {{ warnf "Wrong output received from Go Playground in %v:%v:\ngot:\n%vwant:\n%v" .Page.File.Path .Position.LineNumber $compiledOutput $output }}
  {{ else }}
    {{ warnf "Received unexpected output from Go Playground. Add an `<!--output-->` block in %v:%v:\ngot:\n%v" .Page.File.Path .Position.LineNumber $compiledOutput }}
  {{ end }}
{{ end }}

{{ if $withoutBoilerplate }}
    {{/* After formatting, we want to remove the boilerplate again */}}
    {{ $code = strings.TrimPrefix "package main\n\nimport \"fmt\"\n\nfunc main() {\n" $code }}
    {{ $code = strings.TrimSuffix "}\n" $code }}

    {{/* Trim first tab from every line */}}
    {{ $code = split $code "\n" }}
    {{ $code = apply $code "strings.TrimPrefix" "\t" "." }}
    {{ $code = delimit $code "\n" }}
{{ end }}

{{/* We split the options into separate shortcode params,
     because the highlight function silently fails if unknown
     options are passed. */}}
{{ $options := slice }}
{{ with $hlLines }}
    {{ $options = $options | append (printf "hl_lines=%v" .) }}
{{ end }}
{{ with $lineNos }}
    {{ $options = $options | append (printf "lineNos=%v" .) }}
{{ else }}
    {{ $options = $options | append "lineNos=true" }}
{{ end }}

<div class="go-playground" data-playground="{{ $share }}">
{{/* We add something to each empty line and remove it after highlighting */}}
{{/* https://github.com/gohugoio/hugo/issues/7848 */}}
{{ $code = replace $code "\n\n" "\n__NL__\n" }}
{{ $highlighted := transform.Highlight $code "go" (delimit $options ",") }}
{{- replace $highlighted "__NL__" "" | safeHTML -}}
Output:
<pre class="output">
{{ $output }}
</pre>
</div>
